<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Clínico de Reacción Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #2c3e50; --red: #e74c3c; --green: #2ecc71; --blue: #3498db; --text: white; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: background 0.2s; overflow: hidden; }
        
        /* Navegación y Ajustes */
        .header-nav { width: 100%; display: flex; justify-content: flex-end; padding: 10px; gap: 10px; z-index: 10; }
        .btn-icon { background: rgba(255,255,255,0.1); border: 1px solid white; color: white; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 1.2rem; }
        
        .config-panel { display: none; position: absolute; top: 60px; right: 10px; background: white; color: #333; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 200px; }

        .game-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; cursor: pointer; }
        .panel-info { background: rgba(0,0,0,0.4); padding: 30px; border-radius: 20px; text-align: center; max-width: 90%; pointer-events: none; }
        
        /* Panel Profesional */
        #admin-section { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; color: #333; overflow-y: auto; padding: 25px; box-sizing: border-box; z-index: 100; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        
        .btn-print { background: var(--blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: var(--blue); color: white; }

        @media print {
            .header-nav, .config-panel, .admin-header button, .btn-print { display: none !important; }
            #admin-section { position: relative; display: block !important; padding: 0; }
        }
    </style>
</head>
<body>

    <div class="header-nav">
        <button class="btn-icon" onclick="toggleConfig()">⚙️</button>
        <button class="btn-icon" style="font-size: 0.9rem;" onclick="accesoProfesional()">Área Profesional</button>
    </div>

    <div id="config-panel" class="config-panel">
        <strong>Configuración</strong>
        <hr>
        <label>Modo Visual:</label>
        <select id="colorMode" onchange="cambiarModo()">
            <option value="clasico">Clásico (Rojo/Verde)</option>
            <option value="contraste">Contraste (Negro/Blanco)</option>
            <option value="daltonico">Daltónico (Azul/Amarillo)</option>
        </select>
        <br><br>
        <label><input type="checkbox" id="soundToggle" checked> Sonido al activarse</label>
    </div>

    <div class="game-container" id="area-juego" onclick="manejarClic()">
        <div class="panel-info">
            <h1 id="mensaje">Tiempo de Reacción</h1>
            <p id="instruccion">Toca para comenzar</p>
            <h2 id="cronometro" style="font-size: 3rem;">0 ms</h2>
        </div>
    </div>

    <div id="admin-section">
        <div class="admin-header">
            <h2>Expedientes Clínicos</h2>
            <button class="btn-icon" style="background:var(--red); border:none;" onclick="cerrarAdmin()">Cerrar</button>
        </div>
        <select id="pacienteSelect" onchange="actualizarVistaAdmin()" style="padding:10px; width:100%; margin-bottom:20px;">
            <option value="">-- Seleccionar Paciente --</option>
        </select>
        <div id="datosPaciente" style="display:none;">
            <button class="btn-print" onclick="window.print()">Exportar PDF / Imprimir</button>
            <canvas id="progresoChart" style="margin:20px 0;"></canvas>
            <table id="tabla-records">
                <thead><tr><th>Fecha</th><th>Hora</th><th>Tiempo (ms)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let estado = "INICIO", startTime, timeout, chart;
        let c_rojo = "#e74c3c", c_verde = "#2ecc71", c_neutro = "#2c3e50";
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function beep() {
            if (!document.getElementById('soundToggle').checked) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = 880; gain.gain.value = 0.1;
            osc.start(); setTimeout(() => osc.stop(), 100);
        }

        function cambiarModo() {
            let modo = document.getElementById('colorMode').value;
            if (modo === "clasico") { c_rojo = "#e74c3c"; c_verde = "#2ecc71"; c_neutro = "#2c3e50"; }
            else if (modo === "contraste") { c_rojo = "#000000"; c_verde = "#ffffff"; c_neutro = "#333333"; }
            else { c_rojo = "#3498db"; c_verde = "#f1c40f"; c_neutro = "#2c3e50"; }
            document.body.style.backgroundColor = c_neutro;
        }

        function toggleConfig() {
            let p = document.getElementById('config-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        function manejarClic() {
            if (estado === "INICIO" || estado === "RESULTADO") preparar();
            else if (estado === "ESPERA") penalizar();
            else if (estado === "ESTIMULO") finalizar();
        }

        function preparar() {
            estado = "ESPERA";
            document.body.style.backgroundColor = c_rojo;
            document.getElementById('mensaje').innerText = "¡Atento!";
            timeout = setTimeout(() => {
                estado = "ESTIMULO";
                document.body.style.backgroundColor = c_verde;
                if (document.getElementById('colorMode').value === "contraste") document.body.style.color = "black";
                else document.body.style.color = "white";
                document.getElementById('mensaje').innerText = "¡YA!";
                beep();
                startTime = performance.now();
            }, Math.floor(Math.random() * 3000) + 2000);
        }

        function penalizar() {
            clearTimeout(timeout); estado = "RESULTADO";
            document.body.style.backgroundColor = c_neutro;
            document.body.style.color = "white";
            document.getElementById('mensaje').innerText = "¡Muy pronto!";
        }

        function finalizar() {
            let tiempo = Math.round(performance.now() - startTime);
            estado = "RESULTADO";
            document.body.style.backgroundColor = c_neutro;
            document.body.style.color = "white";
            document.getElementById('mensaje').innerText = tiempo + " ms";
            guardarDato(tiempo);
        }

        function guardarDato(ms) {
            let nombre = prompt("Nombre del Paciente:") || "Anónimo";
            let registros = JSON.parse(localStorage.getItem('db_reaccion') || "[]");
            registros.push({
                nombre: nombre.trim().toUpperCase(),
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                tiempo: ms
            });
            localStorage.setItem('db_reaccion', JSON.stringify(registros));
        }

        function accesoProfesional() {
            if (prompt("Clave:") === "1234") {
                document.getElementById('admin-section').style.display = 'block';
                poblarSelect();
            }
        }

        function poblarSelect() {
            let registros = JSON.parse(localStorage.getItem('db_reaccion') || "[]");
            let nombres = [...new Set(registros.map(r => r.nombre))];
            let select = document.getElementById('pacienteSelect');
            select.innerHTML = '<option value="">-- Seleccionar Paciente --</option>';
            nombres.forEach(n => {
                let opt = document.createElement('option');
                opt.value = n; opt.innerText = n;
                select.appendChild(opt);
            });
        }

        function actualizarVistaAdmin() {
            let nombreSel = document.getElementById('pacienteSelect').value;
            let container = document.getElementById('datosPaciente');
            if (!nombreSel) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            let filtrados = JSON.parse(localStorage.getItem('db_reaccion')).filter(r => r.nombre === nombreSel);
            document.querySelector("#tabla-records tbody").innerHTML = filtrados.reverse().map(r => `<tr><td>${r.fecha}</td><td>${r.hora}</td><td>${r.tiempo} ms</td></tr>`).join('');
            
            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('progresoChart'), {
                type: 'line',
                data: {
                    labels: filtrados.map(r => r.fecha).reverse(),
                    datasets: [{ label: 'Velocidad (ms)', data: filtrados.map(r => r.tiempo).reverse(), borderColor: '#3498db' }]
                },
                options: { animation: false }
            });
        }

        function cerrarAdmin() { document.getElementById('admin-section').style.display = 'none'; }
    </script>
</body>
</html>
